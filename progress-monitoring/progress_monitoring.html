<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Progress Monitoring - LGU IPMS</title>
    <link rel="stylesheet" href="progress-monitoring.css">
</head>
<body>
    <header class="nav" id="navbar">
        <div class="nav-logo">
            <img src="../logocityhall.png" alt="City Hall Logo" class="logo-img">
            <span class="logo-text">IPMS</span>
        </div>
        <div class="nav-links">
            <a href="../dashboard/dashboard.html">Dashboard Overview</a>
            <a href="../project-registration/project_registration.html">Project Registration</a>
            <a href="progress_monitoring.html" class="active">Progress Monitoring</a>
            <a href="../budget-resources/budget_resources.html">Budget & Resources</a>
            <a href="../task-milestone/tasks_milestones.html">Task & Milestone</a>
            <a href="../contractors/contractors.html">Contractors</a>
        </div>
        <div class="nav-user">
            <span class="nav-username">Welcome, User</span>
            <a href="../login.html" class="nav-logout">Logout</a>
        </div>
        <div class="lgu-arrow-back">
            <a href="#" id="toggleSidebar">
                <img src="../dashboard/lgu-arrow-back.png" alt="Toggle sidebar">
            </a>
        </div>
    </header>

    <div class="toggle-btn" id="showSidebarBtn">
        <a href="#" id="toggleSidebarShow">
            <img src="../dashboard/lgu-arrow-right.png" alt="Show sidebar">
        </a>
    </div>

    <section class="main-content">
        <div class="dash-header">
            <h1>Progress Monitoring</h1>
            <p>View, filter and update project progress</p>
        </div>

        <div class="recent-projects">
            <div class="pm-controls">
                <div class="pm-left">
                    <input id="pmSearch" type="search" placeholder="Search by project code, name or location">
                </div>
                <div class="pm-right">
                    <select id="pmStatusFilter">
                        <option value="">All Status</option>
                        <option>Draft</option>
                        <option>For Approval</option>
                        <option>Approved</option>
                        <option>On-hold</option>
                        <option>Cancelled</option>
                    </select>

                    <select id="pmSectorFilter">
                        <option value="">All Sectors</option>
                        <option>Road</option>
                        <option>Drainage</option>
                        <option>Building</option>
                        <option>Water</option>
                        <option>Sanitation</option>
                        <option>Other</option>
                    </select>

                    <select id="pmSort">
                        <option value="createdAt_desc">Newest</option>
                        <option value="createdAt_asc">Oldest</option>
                        <option value="progress_desc">Progress (high → low)</option>
                        <option value="progress_asc">Progress (low → high)</option>
                    </select>

                    <button id="exportCsv">Export CSV</button>
                </div>
            </div>

            <h3>Tracked Projects</h3>
            <div id="projectsList" class="projects-list">Loading projects...</div>

            <div id="pmEmpty" class="pm-empty" style="display:none;">No projects match your filters.</div>
        </div>
    </section>

    <footer class="footer">
        <p>&copy; 2026 Local Government Unit. All rights reserved.</p>
    </footer>

    <script>
        // client-only progress monitoring (reads/writes localStorage.projects)
        const projectsKey = 'projects';

        function getProjects() {
            return JSON.parse(localStorage.getItem(projectsKey) || '[]');
        }

        function saveProjects(arr) {
            localStorage.setItem(projectsKey, JSON.stringify(arr));
        }

        function formatCurrency(n) {
            if (!n && n !== 0) return '—';
            return '₱' + Number(n).toLocaleString();
        }

        function renderProjects() {
            const container = document.getElementById('projectsList');
            const projects = getProjects();
            const q = document.getElementById('pmSearch').value.trim().toLowerCase();
            const status = document.getElementById('pmStatusFilter').value;
            const sector = document.getElementById('pmSectorFilter').value;
            const sort = document.getElementById('pmSort').value;

            let filtered = projects.filter(p => {
                if (status && p.status !== status) return false;
                if (sector && p.sector !== sector) return false;
                if (!q) return true;
                return (p.code + ' ' + p.name + ' ' + (p.location||'')).toLowerCase().includes(q);
            });

            if (sort === 'createdAt_desc') filtered.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
            if (sort === 'createdAt_asc') filtered.sort((a,b)=> new Date(a.createdAt) - new Date(b.createdAt));
            if (sort === 'progress_desc') filtered.sort((a,b)=> (b.progress||0) - (a.progress||0));
            if (sort === 'progress_asc') filtered.sort((a,b)=> (a.progress||0) - (b.progress||0));

            if (!filtered.length) {
                container.innerHTML = '';
                document.getElementById('pmEmpty').style.display = 'block';
                return;
            } else {
                document.getElementById('pmEmpty').style.display = 'none';
            }

            const html = filtered.map((p, idx) => {
                const progress = Number(p.progress || 0);
                const pct = Math.min(100, Math.max(0, progress));
                const statusBadge = `<span class="badge status-${(p.status||'').replace(/\s+/g,'').toLowerCase()}">${p.status||'N/A'}</span>`;
                return `
                <div class="project-card" data-idx="${idx}">
                    <div class="pc-head">
                        <div class="pc-title">
                            <strong>${p.code || ''} — ${p.name || 'Unnamed project'}</strong>
                            <div class="pc-meta">${p.location || ''} • ${p.province || ''}</div>
                        </div>
                        <div class="pc-right">${statusBadge}<div class="pc-budget">${formatCurrency(p.budget)}</div></div>
                    </div>

                    <div class="pc-body">
                        <div class="pc-info">
                            <div><small>Sector</small><div>${p.sector || '—'}</div></div>
                            <div><small>Duration</small><div>${p.durationMonths || p.duration || '—'} months</div></div>
                            <div><small>Start</small><div>${p.startDate || '—'}</div></div>
                            <div><small>End</small><div>${p.endDate || '—'}</div></div>
                        </div>

                        <div class="pc-progress">
                            <div class="progress-row">
                                <div class="progress-label">Progress</div>
                                <div class="progress-bar" aria-hidden>
                                    <div class="progress-fill" style="width:${pct}%;"></div>
                                </div>
                                <div class="progress-pct">${pct}%</div>
                            </div>

                            <div class="progress-controls">
                                <input class="progRange" type="range" min="0" max="100" value="${pct}">
                                <input class="progNumber" type="number" min="0" max="100" value="${pct}">
                                <select class="statusSelect">
                                    <option ${p.status==='Draft'?'selected':''}>Draft</option>
                                    <option ${p.status==='For Approval'?'selected':''}>For Approval</option>
                                    <option ${p.status==='Approved'?'selected':''}>Approved</option>
                                    <option ${p.status==='On-hold'?'selected':''}>On-hold</option>
                                    <option ${p.status==='Cancelled'?'selected':''}>Cancelled</option>
                                </select>
                                <button class="btn small btnSave">Save</button>
                                <button class="btn small btnDetails">Details</button>
                            </div>
                        </div>
                    </div>

                    <div class="pc-footer">
                        <small>Registered:</small> ${(p.createdAt ? new Date(p.createdAt).toLocaleString() : '—')}
                    </div>

                    <div class="pc-details" hidden>
                        <h4>Details & Notes</h4>
                        <div class="pc-desc">${(p.description||'No description')}</div>
                        <div class="pc-attachments"><strong>Attachments:</strong> ${(p.attachments && (p.attachments.sitePhotos || p.attachments.plans || p.attachments.otherDocs) ? 
                            ( (p.attachments.sitePhotos||[]).concat(p.attachments.plans||[]).concat(p.attachments.otherDocs||[]).join(', ') ) : 'None' )}</div>
                        <div class="pc-notes">
                            <label>Notes</label>
                            <textarea class="noteText">${p.notes || ''}</textarea>
                            <button class="btn small btnNoteSave">Save Note</button>
                        </div>
                    </div>
                </div>`;
            }).join('');

            container.innerHTML = html;

            // wire up controls
            container.querySelectorAll('.project-card').forEach(card => {
                const idx = Number(card.dataset.idx);
                const range = card.querySelector('.progRange');
                const num = card.querySelector('.progNumber');
                const pctDisplay = card.querySelector('.progress-pct');
                const fill = card.querySelector('.progress-fill');
                const statusSel = card.querySelector('.statusSelect');

                range.addEventListener('input', () => {
                    num.value = range.value;
                    pctDisplay.textContent = range.value + '%';
                    fill.style.width = range.value + '%';
                });

                num.addEventListener('change', () => {
                    let v = Number(num.value);
                    if (v < 0) v = 0;
                    if (v > 100) v = 100;
                    num.value = v;
                    range.value = v;
                    pctDisplay.textContent = v + '%';
                    fill.style.width = v + '%';
                });

                card.querySelector('.btnSave').addEventListener('click', () => {
                    const projects = getProjects();
                    // try to find actual index by code+name, fallback to idx
                    const code = card.querySelector('strong').textContent.split('—')[0].trim();
                    let foundIdx = projects.findIndex(pp => (pp.code||'') === (code||''));
                    if (foundIdx === -1) foundIdx = idx;
                    projects[foundIdx] = projects[foundIdx] || {};
                    projects[foundIdx].progress = Number(range.value);
                    projects[foundIdx].status = statusSel.value;
                    projects[foundIdx].updatedAt = new Date().toISOString();
                    saveProjects(projects);
                    renderProjects();
                });

                card.querySelector('.btnDetails').addEventListener('click', () => {
                    const details = card.querySelector('.pc-details');
                    details.hidden = !details.hidden;
                });

                card.querySelector('.btnNoteSave').addEventListener('click', (ev) => {
                    const projects = getProjects();
                    const note = card.querySelector('.noteText').value;
                    const code = card.querySelector('strong').textContent.split('—')[0].trim();
                    let foundIdx = projects.findIndex(pp => (pp.code||'') === (code||''));
                    if (foundIdx === -1) foundIdx = idx;
                    projects[foundIdx].notes = note;
                    saveProjects(projects);
                    ev.target.textContent = 'Saved';
                    setTimeout(()=> ev.target.textContent = 'Save Note', 1200);
                });
            });
        }

        // filters, search and sort
        document.getElementById('pmSearch').addEventListener('input', renderProjects);
        document.getElementById('pmStatusFilter').addEventListener('change', renderProjects);
        document.getElementById('pmSectorFilter').addEventListener('change', renderProjects);
        document.getElementById('pmSort').addEventListener('change', renderProjects);

        // export CSV
        document.getElementById('exportCsv').addEventListener('click', () => {
            const projects = getProjects();
            if (!projects.length) { alert('No projects to export'); return; }
            const keys = ['code','name','sector','location','province','budget','durationMonths','progress','status','createdAt'];
            const rows = projects.map(p => keys.map(k => `"${(p[k]||'').toString().replace(/"/g,'""')}"`).join(','));
            const csv = ['"' + keys.join('","') + '"', ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'projects_export.csv';
            a.click();
            URL.revokeObjectURL(url);
        });

        // initial render
        document.addEventListener('DOMContentLoaded', () => {
            renderProjects();
        });
    </script>
</body>
</html>